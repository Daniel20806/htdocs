<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂位狀態</title>
</head>

<body>
    <?php
    $servername = "localhost";
    $username = "s1114580";
    $password = "1114580";
    $dbname = "final";

    // 建立PDO連接
    $pdo = new PDO("mysql:host=$servername;dbname=$dbname", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    if (isset($_POST["date"], $_POST["time"], $_POST["row"], $_POST["column"], $_POST["room"])) {
        //$seat = json_decode($_POST["seat"], true);
        $date = $_POST["date"];
        $time = $_POST["time"];
        $row = $_POST["row"];
        $column = $_POST["column"];
        $room = $_POST["room"];
        $sql = "UPDATE seat_fuck SET status = 'avaliable' WHERE 
                date = :date AND time = :time AND row = :row AND `column` = :column AND room = :room";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([':date' => $date, ':time' => $time, ':row' => $row, ':column' => $column, ':room' => $room]);
        echo "<div class='message' style='color: red;'>修改成功。</div>";
        echo '<script>setTimeout(function() {
            window.location.href = "./seat.php"; 
          }, 2000);
          </script>';

    }

    $sql = "SELECT * FROM seat_fuck WHERE status = :status ORDER BY room";

    $stmt = $pdo->prepare($sql);
    $stmt->execute([':status' => 'booked']);

    $results = $stmt->fetchAll(PDO::FETCH_ASSOC);

    echo "<h1>已訂位清單</h1>";
    foreach ($results as $row) {
        echo "<div class='comment'>";
        echo "<h3>座位：" . $row['row'] . "-" . $row['column'] . "</h3>";
        $sql = "SELECT name FROM schedules WHERE 
                room = :room AND date = :date AND time = :time";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([':room' => $row['room'], ':date' => $row['date'], ':time' => $row['time']]);
        $results2 = $stmt->fetch(PDO::FETCH_ASSOC);
        echo "<p>電影: " . $results2['name'] . "</p>";
        echo "<p>日期：" . htmlspecialchars($row['date']) . "</p>";
        echo "<p class='comment-time'>時間: " . htmlspecialchars($row['time']) . "</p>";
        echo "<p>影廳：" . $row['room'];
        $seat_imformation = [$row['date'], $row['time'], $row['row'], $row['column'], $row['room']];
        echo "<td><form action='./seat.php' method='post'>
                <input type='hidden' name='date' value='" . $row['date'] . "'>
                <input type='hidden' name='time' value='" . $row['time'] . "'>
                <input type='hidden' name='row' value='" . $row['row'] . "'>
                <input type='hidden' name='column' value='" . $row['column'] . "'>
                <input type='hidden' name='room' value='" . $row['room'] . "'>
                <input type='submit' class='form-btn-red' value='標記為可選座位'></form></td>";
        echo "</div>";
    }
    ?>
</body>

</html>